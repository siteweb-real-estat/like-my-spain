{% extends 'dashboard/base.html' %} {% load static %}{% load tailwind_filters %} {% block content %}

<h1 class="text-2xl font-bold mb-4 text-center">{% if form.instance.pk %} Update {% else %} Add {% endif %} Property
</h1>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %} {{ form|crispy }}

    <div id="image-forms" class="border rounded-md mt-4 p-4">
        {{ images_formset.management_form }}

        <!-- Display Existing Images -->
        {% if form.instance.pk %}
        <div class="flex w-full border-b mb-4">

            {% for image in form.instance.images.all %}
            <div class="image-form  pb-4 mb-4 flex items-center">
                <img class="w-20 h-20 rounded-md object-cover" src="{{ image.image.url }}" alt="Image Preview">
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Template for New Images -->
        <div class="image-form-template border-b pb-4 mb-4">
            {{ images_formset.empty_form|crispy }}
            <div class="ml-4 flex-shrink-0 image-preview"></div>
            <!-- Container for image preview -->
        </div>

        <button class="btn btn-outline" id="add-image">Add Image</button>

    </div>
    <button class="btn btn-success text-white w-full mt-4" type="submit">Save</button>
</form>


<script>
    function deleteImage(imageId) {
        // Implement deletion logic here, e.g., via AJAX
        console.log(`Deleting image with ID ${imageId}`);
        // Example AJAX call to delete image
        // fetch(`/delete-image/${imageId}`, {
        //     method: 'DELETE',
        // }).then(response => {
        //     if (response.ok) {
        //         // Optionally, remove the HTML element displaying the image
        //         const imageElement = document.getElementById(`image-${imageId}`);
        //         if (imageElement) {
        //             imageElement.remove();
        //         }
        //     } else {
        //         console.error('Failed to delete image');
        //     }
        // }).catch(error => {
        //     console.error('Error deleting image:', error);
        // });
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const formsetPrefix = '{{ images_formset.prefix }}'; // Prefix for formset management
        const totalFormsInput = document.querySelector(`#id_${formsetPrefix}-TOTAL_FORMS`); // Input that tracks total forms
        let formCount = parseInt(totalFormsInput.value, 10); // Current form count

        // Function to handle file selection and display image preview
        function handleFileSelect(event) {
            const input = event.target;
            const previewContainer = input.closest('.image-form').querySelector('.image-preview');
            previewContainer.innerHTML = ''; // Clear any existing previews

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '200px'; // Set max width for preview image
                    img.style.maxHeight = '200px'; // Set max height for preview image
                    previewContainer.appendChild(img); // Append preview image to container
                }
                reader.readAsDataURL(input.files[0]); // Read file as data URL
            }
        }

        // Event listener for "Add Image" button
        document.getElementById('add-image').addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default form submission

            const newForm = document.querySelector('.image-form-template').cloneNode(true); // Clone the template form
            const formRegex = new RegExp(`${formsetPrefix}-(\\d+)-`, 'g');
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, `${formsetPrefix}-${formCount}-`); // Update form indices

            const newInput = newForm.querySelector('input[type="file"]');
            newInput.value = ''; // Reset file input value
            newInput.addEventListener('change', handleFileSelect); // Add event listener for file input change

            newForm.querySelector('.image-preview').innerHTML = ''; // Clear any existing preview in the cloned form

            document.querySelector('#image-forms').appendChild(newForm); // Append cloned form to formset container
            totalFormsInput.value = ++formCount; // Increment form count and update TOTAL_FORMS input
        });

        // Event listeners for existing file inputs to handle file selection and display preview
        document.querySelectorAll('input[type="file"]').forEach(input => {
            input.addEventListener('change', handleFileSelect);
        });
    });
</script>
{% endblock %}